---
title: "Auswertung FITC"
author: "Alexander Kramer"
date: ""
knit: (function(inputFile, encoding) {
    rmarkdown::render(inputFile, encoding = encoding, output_dir = "./")
  })
output: 
  html_document:
    numbered: yes
    df_print: paged
    toc: yes
    toc_float: true
    self_contained: false
    source_code: embed
    code_download: true
editor_options: 
  chunk_output_type: inline
---

\


# Setup R

```{r setup, results = 'hide', message=FALSE, warning=FALSE}
packages <- c("knitr",
              "shiny",
              "Rmisc",
              "tidyverse",
              "ez",
              "rmdformats",
              "rmarkdown",
              "ggsci",
              "viridis",
              "lemon",
              "posterdown",
              "rprojroot"
              )
           

if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}

library("tidyverse")
library(knitr)

writeLines(capture.output(sessionInfo()), paste0(format(Sys.time(), "%Y%b%d"),"sessionInfo.txt"))



opts_knit$set(
               root.dir = rprojroot::find_rstudio_root_file(),
               base.dir = rprojroot::find_rstudio_root_file()
              )
```

\


# Empirische Hypothesen und Skizze

\
Bedrohliche Gesichter werden in einer Menge emotionaler Distraktoren schneller gefunden als freundliche Gesichter. Zudem ist die Antwortgenauigkeit bei Trials mit bedrohlichen Gesichtern höher.

\

**Skizze** \ 


![Skizze](Grafiken/StudieRes.PNG)


\

# Import

```{r}
data.files <- list.files("Alle Daten/")
data.df <- data.frame()

# data.df aller VPs einlesen
for (file in data.files){
  data = read.csv(paste0("./Alle Daten/", file ), header=TRUE, fileEncoding = "UTF-8-BOM")
  data.df = rbind(data.df, data)
}
```

\

# Bereingiung

## Übungstrials entfernen

```{r}
data.df <- data.df %>%
  filter(phase != "uebung")
data.df
```

## data.dfstruktur prüfen und Faktoren definieren

```{r}
str(data.df)

data.df <- data.df %>%
  rename("Expositionszeit" = Condition1,
         "TargetTyp" = Condition2) %>%
  mutate(
    id = factor(id),
    Expositionszeit= recode_factor(Expositionszeit, "-1"= "1", "1"="2"),
    TargetTyp = recode_factor(TargetTyp, "-1"= "friendly", "1"="threating"),
    gender = recode_factor(gender, w = "weiblich", m = "männlich", d = "divers")
  )

str(data.df)


```

\

## Vollständigkeit der data.df prüfen



```{r Vollstaendigkeit}
# Anzahl der Zeilen im data.dfsatz
data.df %>% count()
# Anzahl der Trials pro Bedingung

data.df %>%
  group_by(id, Expositionszeit, TargetTyp) %>%  # UV: muss durch Spaltenname ersetzt werden
  summarise(n=n())

data.df %>%
  group_by(id, Expositionszeit, TargetTyp) %>%  # UV: muss durch Spaltenname ersetzt werden
  count()

```

# Aggregation Einer VP

## Analyse der Antwortgenauigkeit

Die Analyse der Antwortgenauigkeit (RA - Response Accuracy) soll pro Bedingung erfolgen. Die Antwortgenauigkeit kann berechnet werden als...

* Summe richtiger Antworten
* Anteil richtiger Antworten an allen Trials einer Bedingung



```{r Antwortgenauigkeit}
data.df %>%
  group_by(id, Expositionszeit, TargetTyp) %>%
  summarise(RA.Summe = sum(corr),
            RA.Anteil = mean(corr),
            RA.Anteil2 =sum(corr)/n() )

```

\

## Analyse der Reaktionszeiten

### visuelle Inspektion

data.df filtern: Ausschluss von Trials, in denen die VP falsch reagiert hat
```{r Reaktionszeit Filter, eval = T}

# data.df filtern: Ausschluss von Trials, in denen die VP falsch reagiert hat
data.ohneFehler.df <- data.df %>%
  filter(corr == 1)
```


\

**Verteilung der Reaktionszeiten pro Bedingung und VP** 

#### {.tabset}

\

```{r,  eval = T, echo = F, warning=FALSE}


plots <- data.df %>% 
         group_by(id) %>% 
         do( plots= ggplot( data=., aes(x= TargetTyp , y=rt)) + 
               geom_boxplot() + 
               geom_jitter()+ 
               facet_grid(~Expositionszeit) + 
               ggtitle(paste0("VP:", .$id))
)


```

\

```{r, echo=F, results='asis'}

for(i in seq_along(plots[[1]])){
  cat("##### VP: ", as.character(plots[[1]][[i]]) , "\n")
  print(plots[[2]][[i]])
  cat("\n\n")
}

    

```

#### {.unlisted}


\

### Ausreißer Reaktionszeiten {#Ausreisser}


```{r, echo=T, eval = T, message=FALSE, warning=FALSE}
data.ohneFehler.df %>%
  filter(rt > 200) %>%
  group_by(id, Expositionszeit,TargetTyp) %>%
  mutate(remain = (rt < mean(rt) + 3*sd(rt))) %>%
  group_by(id, Expositionszeit,TargetTyp) %>%
  summarise(RA.remain = sum(remain)/n())


data.RT.df <- data.ohneFehler.df %>%
  filter(rt > 200) %>%
  group_by(id, Expositionszeit,TargetTyp) %>%
  filter(rt < mean(rt) + 3*sd(rt))

```

### VPs ausschließen

#### Boxplot alle Vps

```{r}
data.boxplot <- data.RT.df %>% 
  group_by(id, Expositionszeit, TargetTyp) %>% 	
  dplyr::summarise(
            mean.rt	= mean(rt),
            sd.rt 	= sd(rt),
            n 	= dplyr::n()
            )

pd = position_jitter(0.4, seed=1)

ggplot(data = data.boxplot, aes(x = TargetTyp , y = mean.rt, label = id)) + 
  geom_boxplot() + 
  geom_point(position = pd) + 
  facet_grid( ~ Expositionszeit) + 
  geom_text(position = pd, hjust = 1.5)
```

```{r, warning=FALSE}
data.CORR.df <- data.df %>%
  filter(rt > 200) %>%
  group_by(id, Expositionszeit,TargetTyp) %>%
  filter(rt < mean(rt) + 3*sd(rt))

data.boxplot.corr <- data.CORR.df %>% 
  group_by(id, Expositionszeit, TargetTyp) %>% 	
  dplyr::summarise(mean.corr = mean(corr),
            n 	= dplyr::n())

pd = position_jitter(0.25, seed=1)
ggplot(data = data.boxplot.corr, aes(x = TargetTyp , y = mean.corr, label = id)) + 
  geom_boxplot() + 
  geom_point(position = pd) + 
  facet_grid( ~ Expositionszeit) + 
  geom_text(position = pd, hjust = 1.5)

```

####  zu wenig Trials / Auffällige Reaktionszeiten


```{r}
vp.err<- data.ohneFehler.df %>% 
  group_by(Expositionszeit, TargetTyp) %>%
  mutate(mean.rt = mean(rt),
         sd.rt = sd(rt)) %>%
  group_by(id, Expositionszeit, TargetTyp) %>%
  mutate(nTrials = n())%>%
  filter(mean(rt) > mean.rt + 3*sd.rt |                     # wichtig: größer als obere Grenze 
         mean(rt) < mean.rt -  3*sd.rt|# wichtig: kleiner als untere Grenze 
         nTrials < 0.55*54 # Muss ggf. pro VP und Bedingung geprüft werden!
         ) %>%  
  select(id) %>%
  distinct() %>% 
  pull(id)

vp.err

data.clean.rt <- data.ohneFehler.df %>% filter(!(id %in% vp.err))
data.clean.corr <- data.CORR.df %>% filter(!(id %in% vp.err))

```


# Aggregation Aller VP

```{r}
data.clean.corr.sum <- data.clean.corr %>%
  group_by(id, Expositionszeit, TargetTyp) %>% 	
  dplyr::summarise(mean.corr = mean(corr),
                   sd.corr = sd(corr),
                   n 	= dplyr::n(),
                   sem.corr = sd.corr/sqrt(n))

data.clean.rt.sum <- data.clean.rt %>%
  group_by(id, Expositionszeit, TargetTyp) %>% 	
  dplyr::summarise(mean.rt = mean(rt),
                   sd.rt = sd(rt),
                   n 	= dplyr::n(),
                   sem.rt = sd.rt/sqrt(n))
```

\

# Finale Grafik

```{r}

```

\

# Inferenzstatistik

```{r}

```

